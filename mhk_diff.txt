diff --git a/SpecimenDetail_body.cfm b/SpecimenDetail_body.cfm
index 36f0aec..8adaf11 100644
--- a/SpecimenDetail_body.cfm
+++ b/SpecimenDetail_body.cfm
@@ -210,14 +210,19 @@
 			#oneOfUs# != 1 and concatencumbrances(collector.collection_object_id) like '%mask collector%' then 'Anonymous'
 		else
 			preferred_agent_name.agent_name
-		end collectors
+		end collectors,
+		case when
+			#oneOfUs# != 1 and concatencumbrances(collector.collection_object_id) like '%mask collector%' then NULL
+		else
+			preferred_agent_name.agent_id
+		end collector_id
 	from
 		collector,
 		preferred_agent_name
 	where
 		collector.collector_role='c' and
 		collector.agent_id=preferred_agent_name.agent_id and
-		collector.collection_object_id = #collection_object_id#
+		collector.collection_object_id = <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#collection_object_id#">
 	ORDER BY
 		coll_order
 </cfquery>
@@ -228,14 +233,19 @@
 			#oneOfUs# != 1 and concatencumbrances(collector.collection_object_id) like '%mask preparator%' then 'Anonymous'
 		else
 			preferred_agent_name.agent_name
-		end preparators
+		end preparators,
+		case when
+			#oneOfUs# != 1 and concatencumbrances(collector.collection_object_id) like '%mask preparator%' then NULL
+		else
+			preferred_agent_name.agent_id
+		end preparator_id
 	from
 		collector,
 		preferred_agent_name
 	where
 		collector.collector_role='p' and
 		collector.agent_id=preferred_agent_name.agent_id and
-		collector.collection_object_id = #collection_object_id#
+		collector.collection_object_id = <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#collection_object_id#">
 	ORDER BY
 		coll_order
 </cfquery>
@@ -253,7 +263,7 @@
 		preferred_agent_name attribute_determiner
 	where
 		attributes.determined_by_agent_id = attribute_determiner.agent_id and
-		attributes.collection_object_id = #collection_object_id#
+		attributes.collection_object_id = <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#collection_object_id#">
 </cfquery>
 <cfquery name="relns" datasource="user_login" username="#session.dbuser#" password="#decrypt(session.epw,cfid)#">
 SELECT distinct biol_indiv_relationship, related_collection, related_coll_object_id, related_cat_num, biol_indiv_relation_remarks FROM (
@@ -271,7 +281,7 @@ FROM
          on collection.collection_id = rcat.collection_id
      left join ctbiol_relations ctrel
       on rel.biol_indiv_relationship = ctrel.biol_indiv_relationship
-WHERE rel.collection_object_id=#collection_object_id#
+WHERE rel.collection_object_id = <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#collection_object_id#">
       and ctrel.rel_type <> 'functional'
 UNION
 SELECT
@@ -288,7 +298,7 @@ FROM
       on irel.collection_object_id = rcat.collection_object_id
      left join collection
       on collection.collection_id = rcat.collection_id
-WHERE irel.related_coll_object_id=#collection_object_id#
+WHERE irel.related_coll_object_id = <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#collection_object_id#">
       and ctrel.rel_type <> 'functional'
 )
 </cfquery>
@@ -296,21 +306,25 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 	SELECT
 		citation.type_status,
 		citation.occurs_page_number,
+		citation.citation_page_uri,
 		citation.CITATION_REMARKS,
 		cited_taxa.scientific_name as cited_name,
 		cited_taxa.taxon_name_id as cited_name_id,
 		formatted_publication.formatted_publication,
 		formatted_publication.publication_id,
-                cited_taxa.taxon_status as cited_name_status
+		publication.doi,
+        cited_taxa.taxon_status as cited_name_status
 	from
 		citation,
 		taxonomy cited_taxa,
-		formatted_publication
+		formatted_publication,
+		publication
 	where
 		citation.cited_taxon_name_id = cited_taxa.taxon_name_id  AND
 		citation.publication_id = formatted_publication.publication_id AND
 		format_style='short' and
-		citation.collection_object_id = #collection_object_id#
+		citation.publication_id = publication.publication_id and
+		citation.collection_object_id = <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#collection_object_id#">
 	order by
 		substr(formatted_publication, - 4)
 </cfquery>
@@ -367,7 +381,7 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 									(select * from formatted_publication where format_style='short') formatted_publication
 								WHERE
 									identification.publication_id=formatted_publication.publication_id (+) and
-									identification.collection_object_id = #collection_object_id#
+									identification.collection_object_id = <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#collection_object_id#">
 								ORDER BY accepted_id_fg DESC,sort_order, made_date DESC
 							</cfquery>
 							<cfloop query="identification">
@@ -386,7 +400,7 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 									WHERE
 										identification_taxonomy.taxon_name_id = taxonomy.taxon_name_id and
 										taxonomy.taxon_name_id=common_name.taxon_name_id (+) and
-										identification_id=#identification_id#
+										identification_id = <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#identification_id#">
 								</cfquery>
 								<cfquery name="getTaxa" dbtype="query">
 									select
@@ -449,7 +463,7 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 									</cfif>
 									Identified by #agent_name#
 									<cfif len(made_date) gt 0>
-										on #dateformat(made_date,"yyyy-mm-dd")#
+										<cfif len(made_date) gt 8> on <cfelse> in </cfif>#made_date#
 									</cfif>
 									<br>Nature of ID: #nature_of_id#
 									<cfif len(identification_remarks) gt 0>
@@ -472,10 +486,19 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 									target="_mainFrame">
 										#formatted_publication#</a>,
 								<cfif len(occurs_page_number) gt 0>
-									Page #occurs_page_number#,
+									Page
+										<cfif len(citation_page_uri) gt 0>
+											<a href ="#citation_page_uri#" target="_blank">#occurs_page_number#</a>,
+										<cfelse>
+											#occurs_page_number#,
+										</cfif>
+								<cfelse>
+									<cfif len(citation_page_uri) gt 0>
+										<a href ="#citation_page_uri#" target="_blank">[link]</a>,
+									</cfif>
 								</cfif>
 								#type_status# of
-								<a href="/TaxonomyDetails.cfm?taxon_name_id=#cited_name_id#" target="_mainFrame"><i>#replace(cited_name," ","&nbsp;","all")#</i></a>
+								<a href="/taxonomy/showTaxonomy.cfm?taxon_name_id=#cited_name_id#" target="_mainFrame"><i>#replace(cited_name," ","&nbsp;","all")#</i></a>
 								<cfif find("(ms)", #type_status#) NEQ 0>
 									<!--- Type status with (ms) is used to mark to be published types,
 `										for which we aren't (yet) exposing the new name.  Append sp. nov or ssp. nov.
@@ -487,7 +510,12 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 									</cfif>
 								</cfif>
 								<div class="detailCellSmall">
+									<cfif len(#DOI#) GT 0>
+									doi: <a target="_blank" href='https://doi.org/#DOI#'>#DOI#</a><br>
+									</cfif>
+									<cfif len(#CITATION_REMARKS#) GT 0>
 									#CITATION_REMARKS#<BR>
+									</cfif>
 								</div>
 							</span>
 						</div>
@@ -496,9 +524,14 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 					</cfloop>
 					<cfquery name="publicationMedia"  datasource="user_login" username="#session.dbuser#" password="#decrypt(session.epw,cfid)#">
 								select
-									mr.media_id, m.media_uri, m.preview_uri, ml.label_value descr, m.media_type, m.mime_type
+									mr.media_id, m.media_uri, m.preview_uri, ml.label_value descr, m.media_type, m.mime_type,
+									mczbase.get_media_descriptor(m.media_id) as media_descriptor 
 								from
-									media_relations mr, media_labels ml, media m, citation c, formatted_publication fp
+									media_relations mr, 
+									media_labels ml, 
+									media m, 
+									citation c, 
+									formatted_publication fp
 								where
 									mr.media_id = ml.media_id and
 									mr.media_id = m.media_id and
@@ -507,13 +540,14 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 									RELATED_PRIMARY_KEY = c.publication_id and
 									c.publication_id = fp.publication_id and
 									fp.format_style='short' and
-									c.collection_object_id = #collection_object_id#
+									c.collection_object_id = <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#collection_object_id#">
 								order by substr(formatted_publication, -4)
 							</cfquery>
 									<cfif publicationMedia.recordcount gt 0>
 								            <span class="detailData">
 													<div class="thumb_spcr">&nbsp;</div>
 													<cfloop query="publicationMedia">
+														<cfset altText = publicationMedia.media_descriptor>
 														<cfset puri=getMediaPreview(preview_uri,media_type)>
 										            	<cfquery name="labels"  datasource="user_login" username="#session.dbuser#" password="#decrypt(session.epw,cfid)#">
 															select
@@ -522,21 +556,21 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 															from
 																media_labels
 															where
-																media_id=#media_id#
+																media_id=<cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#media_id#">
 														</cfquery>
 														<cfquery name="desc" dbtype="query">
 															select label_value from labels where media_label='description'
 														</cfquery>
-														<cfset alt="Media Preview Image">
+														<cfset mediadescription="Media Preview Image">
 														<cfif desc.recordcount is 1>
-															<cfset alt=desc.label_value>
+															<cfset mediadescription=desc.label_value>
 														</cfif>
 										               <div class="one_thumb_small">
-											               <a href="#media_uri#" target="_blank"><img src="#getMediaPreview(preview_uri,media_type)#" alt="#alt#" class="theThumbSmall"></a>
+											               <a href="#media_uri#" target="_blank"><img src="#getMediaPreview(preview_uri,media_type)#" alt="#altText#" class="theThumbSmall"></a>
 										                   	<div class="detailCellSmall">
 																#media_type# (#mime_type#)
 											                   	<br><a href="/media/#media_id#" target="_blank">Media Details</a>
-																<br>#alt#
+																<br>#mediadescription#
 															</div>
 														</div>
 													</cfloop>
@@ -613,7 +647,7 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 						from
 							media_relations
 						where
-							RELATED_PRIMARY_KEY=#one.locality_id# and
+							RELATED_PRIMARY_KEY= <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#one.locality_id#"> and
 							MEDIA_RELATIONSHIP like '% locality'
 					</cfquery>
 					<cfif len(one.spec_locality) gt 0>
@@ -633,13 +667,13 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 						from
 							media_relations
 						where
-							RELATED_PRIMARY_KEY=#one.collecting_event_id# and
+							RELATED_PRIMARY_KEY=<cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#one.collecting_event_id#"> and
 							MEDIA_RELATIONSHIP like '% collecting_event'
 					</cfquery>
 					<cfif one.verbatim_locality is not one.spec_locality>
 						<cfif len(one.verbatim_locality) gt 0>
 							<tr class="detailData">
-								<td id="SDCellLeft" class="innerDetailLabel">Verbatim Locality:</td>
+								<td id="SDCellLeft" class="innerDetailLabel">Verbatim Locality: </td>
 								<td id="SDCellRight">#one.verbatim_locality#
 									<cfif collEventMedia.recordcount gt 0>
 										<a class="infoLink" target="_blank"	href="/MediaSearch.cfm?action=search&media_id=#valuelist(collEventMedia.media_id)#">Media</a>
@@ -648,9 +682,6 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 							</tr>
 						</cfif>
 					</cfif>
-
-
-
 					<cfif len(one.locality_remarks) gt 0>
 						<tr class="detailData">
 							<td id="SDCellLeft" class="innerDetailLabel">Locality Remarks:</td>
@@ -735,13 +766,13 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 								<tr class="detailCellSmall">
 									<td></td>
 									<td class="innerDetailLabel" style="padding-left: 1.75em;padding-top: 0;padding-bottom: .5em;">Coordinate Remarks:
-										#one.lat_long_remarks#
+										#encodeForHTML(one.lat_long_remarks)#
 									</td>
 								</tr>
 							</cfif>
 							<cfif len(one.verbatimcoordinates) gt 0>
 								<tr class="detailData">
-									<td id="SDCellLeft" class="innerDetailLabel">Verbatim Coordinates:</td>
+									<td id="SDCellLeft" class="innerDetailLabel">Verbatim Coordinates: </td>
 									<td id="SDCellRight">#one.verbatimcoordinates#</td>
 								</tr>
 							</cfif>
@@ -774,7 +805,7 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 							 locality_id=#one.locality_id#
 						</cfquery>
 						<cfloop query="geology">
-							 <td id="SDCellLeft" class="innerDetailLabel">#GEOLOGY_ATTRIBUTE#:</td>
+							 <td id="SDCellLeft" class="innerDetailLabel">#GEOLOGY_ATTRIBUTE#: </td>
 							 <td id="SDCellRight">
 								 #GEO_ATT_VALUE#
 							</td>
@@ -810,13 +841,13 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 						<cfset thisDate = "#one.verbatim_date# (#one.began_date# - #one.ended_date#)">
 					</cfif>
 					<tr class="detailData">
-						<td id="SDCellLeft" class="innerDetailLabel">Collecting Date:</td>
-						<td id="SDCellRight">#thisDate#</td>
+						<td id="SDCellLeft" class="innerDetailLabel">Collecting Date: </td>
+						<td id="SDCellRight"> #thisDate#</td>
 					</tr>
 					<cfif len(one.startDayOfYear) gt 0>
 					<tr class="detailData">
-						<td id="SDCellLeft" class="innerDetailLabel">Day of Year (start-end):</td>
-						<td id="SDCellRight">#startDayOfYear#<cfif len(one.endDayOfYear) gt 0>-#endDayOfYear#</cfif></td>
+						<td id="SDCellLeft" class="innerDetailLabel">Day of Year (start-end): </td>
+						<td id="SDCellRight"> #startDayOfYear#<cfif len(one.endDayOfYear) gt 0>-#endDayOfYear#</cfif></td>
 					</tr>
 					</cfif>
 					<cfif len(one.collecting_time) gt 0>
@@ -837,6 +868,30 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 						<td id="SDCellRight">#coll_event_remarks#</td>
 					</tr>
 					</cfif>
+					<cfquery name="collEventNumbers"  datasource="user_login" username="#session.dbuser#" password="#decrypt(session.epw,cfid)#">
+						select
+							coll_event_number, number_series, 
+							case 
+								when collector_agent_id is null then '[No Agent]'
+								else MCZBASE.get_agentnameoftype(collector_agent_id, 'preferred') 
+							end
+							as collector_agent_name
+						from
+							coll_event_number
+							left join coll_event_num_series on coll_event_number.coll_event_num_series_id = coll_event_num_series.coll_event_num_series_id
+						where
+							collecting_event_id = <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#one.collecting_event_id#"> 
+					</cfquery>
+					<cfif collEventNumbers.recordcount gt 0>
+					<tr class="detailData">
+						<td id="SDCellLeft" class="innerDetailLabel" nowrap>Collecting Event/Field Number:</td>
+						<td id="SDCellRight"><ul>
+							<cfloop query="collEventNumbers">
+								<li>#coll_event_number# (#number_series# of #collector_agent_name#)</li>
+							</cfloop>
+						</ul></td>
+					</tr>
+					</cfif>
 				</table>
 			</div>
 
@@ -848,10 +903,16 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 					</cfif>
 				</div>
 				<cfloop query="colls">
+					<cfset collectorLink ="">
+					<cfset collectorLinkEnd ="">
+					<cfif len(collector_id) GT 0>
+						<cfset collectorLink = "<a href='/agents/Agent.cfm?agent_id=#collector_id#' target='_blank'>" >
+						<cfset collectorLinkEnd ="</a>">
+					</cfif>
 					<div class="detailBlock">
 						<span class="detailData">
 							<span class="innerDetailLabel"></span>
-							#collectors#
+							#collectorLink##collectors##collectorLinkEnd#
 						</span>
 					</div>
 				</cfloop>
@@ -865,15 +926,56 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 						</cfif>
 					</div>
 					<cfloop query="preps">
+						<cfset preparatorLink ="">
+						<cfset preparatorLinkEnd ="">
+						<cfif len(preparator_id) GT 0>
+							<cfset preparatorLink = "<a href='/agents/Agent.cfm?agent_id=#preparator_id#' target='_blank'>" >
+							<cfset preparatorLinkEnd ="</a>">
+						</cfif>
 						<div class="detailBlock">
 							<span class="detailData">
 								<span class="innerDetailLabel"></span>
-								#preparators#
+								#preparatorLink##preparators##preparatorLinkEnd#
 							</span>
 						</div>
 					</cfloop>
 				</div>
 			</cfif>
+<!------------------------------------ collections ---------------------------------------------->
+			<cfquery name="collectionsQuery"  datasource="user_login" username="#session.dbuser#" password="#decrypt(session.epw,cfid)#" result="collectionsQuery_result">
+				select distinct collection_name, underscore_collection.underscore_collection_id, mask_fg
+				from underscore_relation
+					left join underscore_collection on underscore_relation.underscore_collection_id = underscore_collection.underscore_collection_id
+				where
+					underscore_relation.collection_object_id = <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#one.collection_object_id#">
+					<cfif isdefined("session.roles") AND listcontainsnocase(session.roles,"manage_specimens")>
+						-- all groups
+					<cfelse>
+						and mask_fg = 0
+					</cfif>
+			</cfquery>
+			<cfif collectionsQuery.recordcount GT 0>
+				<div class="detailCell">
+					<div class="detailLabel">Included in these Collections
+						<!---  TODO: Implement edit 
+						<cfif isdefined("session.roles") AND listcontainsnocase(session.roles,"manage_specimens")>
+							<span class="detailEditCell" onclick="window.parent.loadEditApp('editColls');">Edit</span>
+						</cfif>
+						--->
+					</div>
+					<div class="detailBlock">
+						<ul>
+							<cfloop query="collectionsQuery">
+								<cfif collectionsQuery.mask_fg EQ 0 OR (isdefined("session.roles") AND listcontainsnocase(session.roles,"coldfusion_user"))>
+									<li><a href="/grouping/showNamedCollection.cfm?underscore_collection_id=#underscore_collection_id#">#collection_name#</a></li>
+								<cfelse>
+									<li>#collection_name#</li>
+								</cfif>
+							</cfloop>
+						</ul>
+					</div>
+				</div>
+			</cfif>
 <!------------------------------------ relationships ---------------------------------------------->
 			<cfif len(relns.biol_indiv_relationship) gt 0 >
 				<div class="detailCell">
@@ -910,7 +1012,7 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 				project, project_trans
 				WHERE
 				project_trans.project_id = project.project_id AND
-				project_trans.transaction_id=#one.accn_id#
+				project_trans.transaction_id = <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#one.accn_id#">
 				GROUP BY project_name, project.project_id
 		  </cfquery>
 		  <cfquery name="isLoan" datasource="user_login" username="#session.dbuser#" password="#decrypt(session.epw,cfid)#">
@@ -962,7 +1064,7 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 				SELECT
 					case when #oneOfUs# != 1 and
 						concatencumbrances(coll_obj_other_id_num.collection_object_id) like '%mask original field number%' and
-						coll_obj_other_id_num.other_id_type = 'original identifier'
+						ctcoll_other_id_type.encumber_as_field_num = 1
 						then 'Masked'
 					else
 						coll_obj_other_id_num.display_value
@@ -1065,7 +1167,7 @@ WHERE irel.related_coll_object_id=#collection_object_id#
                 lot_count,
                 part_remarks
         order by
-                part_name
+                part_name, part_id
 </cfquery>
 
 <cfquery name="mPart" dbtype="query">
@@ -1096,7 +1198,27 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 								<tr>
 									<td class="inside">#part_name#</td>
 									<td class="inside">#part_condition#</td>
-									<td class="inside">#part_disposition#</td>
+									<td class="inside">#part_disposition#
+										<cfif loanList.recordcount GT 0 AND isdefined("session.roles") and listcontainsnocase(session.roles,"manage_transactions")>
+											<!--- look up whether this part is in an open loan --->
+											<cfquery name="partonloan" datasource="user_login" username="#session.dbuser#" password="#decrypt(session.epw,cfid)#">
+												select loan_number, loan_type, loan_status, loan.transaction_id, item_descr, loan_item_remarks
+												from specimen_part left join loan_item on specimen_part.collection_object_id = loan_item.collection_object_id
+													left join loan on loan_item.transaction_id = loan.transaction_id
+												where specimen_part.collection_object_id = <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#mPart.part_id#">
+													and loan_status <> 'closed'
+											</cfquery>
+											<cfloop query="partonloan">
+												<cfif partonloan.loan_status EQ 'open' and mPart.part_disposition EQ 'on loan'>
+													<!--- normal case --->
+													<a href="/transactions/Loan.cfm?action=editLoan&transaction_id=#partonloan.transaction_id#">#partonloan.loan_number#</a>
+												<cfelse>
+													<!--- partial returns, in process, historical, in-house, or in open loan but part disposition in collection--->
+													<a href="/transactions/Loan.cfm?action=editLoan&transaction_id=#partonloan.transaction_id#">#partonloan.loan_number# (#partonloan.loan_status#)</a>
+												</cfif>
+											</cfloop>
+										</cfif>
+									</td>
 									<td class="inside">#lot_count#</td>
 									<cfif oneOfus is 1>
 										<td class="inside">#label#</td>
@@ -1153,16 +1275,34 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 								</cfquery>
 								<cfloop query="sPart">
 									<tr>
-										<td class="inside">
-											#part_name# subsample
+										<td class="inside_sub" style="min-width:150px;"><span>#part_name# subsample</span></td>
+										<td class="inside_sub">#part_condition#</td>
+										<td class="inside_sub">#part_disposition#
+											<cfif loanList.recordcount GT 0 AND isdefined("session.roles") and listcontainsnocase(session.roles,"manage_transactions")>
+												<!--- look up whether this part is in an open loan --->
+												<cfquery name="partonloan" datasource="user_login" username="#session.dbuser#" password="#decrypt(session.epw,cfid)#">
+													select loan_number, loan_type, loan_status, loan.transaction_id, item_descr, loan_item_remarks
+													from specimen_part left join loan_item on specimen_part.collection_object_id = loan_item.collection_object_id
+														left join loan on loan_item.transaction_id = loan.transaction_id
+													where specimen_part.collection_object_id = <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#sPart.part_id#">
+														and loan_status <> 'closed'
+												</cfquery>
+												<cfloop query="partonloan">
+													<cfif partonloan.loan_status EQ 'open' and sPart.part_disposition EQ 'on loan'>
+														<!--- normal case --->
+														<a href="/transactions/Loan.cfm?action=editLoan&transaction_id=#partonloan.transaction_id#">#partonloan.loan_number#</a>
+													<cfelse>
+														<!--- partial returns, in process, historical, in-house, or in open loan but part disposition in collection--->
+														<a href="/transactions/Loan.cfm?action=editLoan&transaction_id=#partonloan.transaction_id#">#partonloan.loan_number# (#partonloan.loan_status#)</a>
+													</cfif>
+												</cfloop>
+											</cfif>
 										</td>
-										<td class="inside">#part_condition#</td>
-										<td class="inside">#part_disposition#</td>
-										<td class="inside">#lot_count#</td>
+										<td class="inside_sub">#lot_count#</td>
 										<cfif oneOfus is 1>
-											<td class="inside">#label#</td>
+											<td class="inside_sub">#label#</td>
 										</cfif>
-										<td class="inside">#part_remarks#</td>
+										<td class="inside_sub">#part_remarks#</td>
 									</tr>
 								</cfloop>
 							</cfloop>
@@ -1292,7 +1432,7 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 									<cfif len(determined_date) gt 0>
 										<cfset determination = '#determination#, #dateformat(determined_date,"yyyy-mm-dd")#'>
 									</cfif>
-									<cfif len(determination_method) gt 0>,
+									<cfif len(determination_method) gt 0>
 										<cfset determination = '#determination#, #determination_method#'>
 									</cfif>
 									<div class="detailBlock">
@@ -1374,61 +1514,88 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 						</cfif>
 					</cfif>
 				</div>
-                                    </div>
+			</div>
 <!------------------------------------ accession ---------------------------------------------->
-			<cfquery name="accnMedia" datasource="user_login" username="#session.dbuser#" password="#decrypt(session.epw,cfid)#">
-			    select
-			        media.media_id,
-			        media.media_uri,
-			        media.mime_type,
-			        media.media_type,
-			        media.preview_uri,
-			        label_value descr
-			     from
-			        media,
-					media_relations,
-					(select media_id,label_value from media_labels where media_label='description') media_labels
-			     where
-			        media.media_id=media_relations.media_id and
-			        media.media_id=media_labels.media_id (+) and
-					media_relations.media_relationship like '% accn' and
-					media_relations.related_primary_key=#one.accn_id#
-			</cfquery>
 			<cfif oneOfUs is 1 and vpdaccn is 1>
-			<div class="detailCell">
-				<div class="detailLabel">Accession
-					<cfif oneOfUs is 1>
-						<span class="detailEditCell" onclick="window.parent.loadEditApp('addAccn');">Edit</span>
-					</cfif>
-				</div>
-				<div class="detailBlock">
-					<span class="detailData">
+				<cfquery name="accnLimitations" datasource="user_login" username="#session.dbuser#" password="#decrypt(session.epw,cfid)#">
+					select specific_type, restriction_summary 
+					from  permit_trans 
+						left join permit on permit_trans.permit_id = permit.permit_id
+					where 
+						permit_trans.transaction_id = <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#one.accn_id#">
+						and permit.restriction_summary IS NOT NULL
+				</cfquery>
+				<cfquery name="accnCollection" datasource="user_login" username="#session.dbuser#" password="#decrypt(session.epw,cfid)#">
+					SELECT collection_cde
+					from trans 
+						left join collection on trans.collection_id = collection.collection_id
+					WHERE
+						trans.transaction_id = <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#one.accn_id#">
+			  	</cfquery>
+				<cfset accnDept = "">
+				<cfif NOT one.collection_cde IS accnCollection.collection_cde>
+					<cfset accnDept = "(#accnCollection.collection_cde#)">
+				</cfif>
+				<cfquery name="accnMedia" datasource="user_login" username="#session.dbuser#" password="#decrypt(session.epw,cfid)#">
+					select
+						media.media_id,
+						media.media_uri,
+						media.mime_type,
+						media.media_type,
+						media.preview_uri,
+						label_value descr,
+						mczbase.get_media_descriptor(media.media_id) as media_descriptor
+					from
+						media,
+						media_relations,
+						(select media_id,label_value from media_labels where media_label='description') media_labels
+					where
+						media.media_id=media_relations.media_id and
+						media.media_id=media_labels.media_id (+) and
+						media_relations.media_relationship like '% accn' and
+						media_relations.related_primary_key= <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#one.accn_id#">
+				</cfquery>
+				<div class="detailCell">
+					<div class="detailLabel">Accession
 						<cfif oneOfUs is 1>
-							<a href="/editAccn.cfm?Action=edit&transaction_id=#one.accn_id#" target="_blank">#accession#</a>
-						<cfelse>
-							#accession#
-						</cfif>
-						<cfif accnMedia.recordcount gt 0>
-							<div class="thumbs">
-								<div class="thumb_spcr">&nbsp;</div>
-								<cfloop query="accnMedia">
-									<div class="one_thumb">
-						            	<a href="#media_uri#" target="_blank">
-							               <img src="#getMediaPreview(preview_uri,media_type)#" alt="#descr#" class="theThumb">
-										</a>
-					                   	<p>
-											#media_type# (#mime_type#)
-						                   	<br><a href="/media/#media_id#" target="_blank">Media Details</a>
-											<br>#descr#
-										</p>
-									</div>
-								</cfloop>
-								<div class="thumb_spcr">&nbsp;</div>
-							</div>
+							<span class="detailEditCell" onclick="window.parent.loadEditApp('addAccn');">Edit</span>
 						</cfif>
-					</span>
+					</div>
+					<div class="detailBlock">
+						<span class="detailData">
+							<cfif oneOfUs is 1>
+								<a href="/transactions/Accession.cfm?action=edit&transaction_id=#one.accn_id#" target="_blank">#accession#</a> #accnDept#
+								<cfif accnLimitations.recordcount GT 0>
+									<h3 class="detailLabel">Restrictions on use</h3>
+									<cfloop query=accnLimitations>
+										<p>#accnLimitations.specific_type#: #accnLimitations.restriction_summary#</p>
+									</cfloop>
+								</cfif>
+							<cfelse>
+								#accession# #accnDept#
+							</cfif>
+							<cfif accnMedia.recordcount gt 0>
+								<div class="thumbs">
+									<div class="thumb_spcr">&nbsp;</div>
+									<cfloop query="accnMedia">
+										<cfset altText = accnMedia.media_descriptor>
+										<div class="one_thumb">
+											<a href="#media_uri#" target="_blank">
+												<img src="#getMediaPreview(preview_uri,media_type)#" alt="#altText#" class="theThumb">
+											</a>
+											<p>
+												#media_type# (#mime_type#)
+												<br><a href="/media/#media_id#" target="_blank">Media Details</a>
+												<br>#descr#
+											</p>
+										</div>
+									</cfloop>
+									<div class="thumb_spcr">&nbsp;</div>
+								</div>
+							</cfif>
+						</span>
+					</div>
 				</div>
-			</div>
 			</cfif>
 <!------------------------------------ usage ---------------------------------------------->
 		<cfif isProj.recordcount gt 0 OR isLoan.recordcount gt 0 or
@@ -1457,7 +1624,7 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 						<div class="detailBlock">
 							<span class="detailData">
 								<span class="innerDetailLabel">Loan History:</span>
-									<a href="/Loan.cfm?action=listLoans&collection_object_id=#valuelist(isLoanedItem.collection_object_id)#"
+									<a href="/Transactions.cfm?action=findLoans&execute=true&collection_object_id=#valuelist(isLoanedItem.collection_object_id)#"
 										target="_mainFrame">Loans that include this cataloged item (#loanList.recordcount#).</a>
 							<cfif isdefined("session.roles") and listcontainsnocase(session.roles,"manage_transactions")>
 							<cfloop query="loanList">
@@ -1471,11 +1638,11 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 						<div class="detailBlock">
 							<span class="detailData">
 								<span class="innerDetailLabel">Deaccessions:</span>
-									<a href="/Deaccession.cfm?action=listDeacc&collection_object_id=#valuelist(isDeaccessionedItem.collection_object_id)#"
+									<a href="/Transactions.cfm?action=findDeaccessions&execute=true&collection_object_id=#valuelist(isDeaccessionedItem.collection_object_id)#"
 										target="_mainFrame">Deaccessions that include this cataloged item (#deaccessionList.recordcount#).</a> &nbsp;
 							<cfif isdefined("session.roles") and listcontainsnocase(session.roles,"manage_transactions")>
 							<cfloop query="deaccessionList">
-								<a href="/Deaccession.cfm?action=editDeacc&transaction_id=#deaccessionList.transaction_id#">#deaccessionList.deacc_number# (#deaccessionList.deacc_type#)</a>&nbsp;
+								<a href="/transactions/Deaccession.cfm?action=edit&transaction_id=#deaccessionList.transaction_id#">#deaccessionList.deacc_number# (#deaccessionList.deacc_type#)</a>&nbsp;
 							</cfloop>
 							</cfif>
 							</span>
@@ -1485,55 +1652,65 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 		</cfif>
 <!------------------------------------ Media ---------------------------------------------->
 <cfquery name="mediaTag" datasource="user_login" username="#session.dbuser#" password="#decrypt(session.epw,cfid)#">
-    select distinct
-        media.media_id,
-        media.media_uri,
-        media.mime_type,
-        media.media_type,
-        media.preview_uri
-     from
-        media,
+	select distinct
+		media.media_id,
+		media.media_uri,
+		media.mime_type,
+		media.media_type,
+		media.preview_uri,
+		mczbase.get_media_descriptor(media.media_id) as media_descriptor
+	from
+		media,
 		tag
-     where
-         media.media_id=tag.media_id and
-		tag.collection_object_id = #collection_object_id#
+	where
+		media.media_id=tag.media_id and
+		tag.collection_object_id = <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#collection_object_id#">
 </cfquery>
 <cfif mediaTag.recordcount gt 0>
 	 <div class="detailCell">
 		<div class="detailLabel">Tagged in Media
 		</div>
 		<div class="detailBlock">
+         <cfset mediaStartTime = #Now()#> 
 			<cfloop query="mediaTag">
-				<cfset puri=getMediaPreview(preview_uri,media_type)>
-				 <span class="detailData">
-					<a href="/showTAG.cfm?media_id=#media_id#" target="_blank"><img src="#puri#"></a>
-		        </span>
+				<cfset altText = mediaTag.media_descriptor>
+         	<cfset mediaLoopTime = #Now()#> 
+				<cfif DateDiff('s',mediaStartTime,mediaLoopTime) GT 10>
+					<!--- Lookups of mediaPreview on slow remote server can exceed the timeout for cfoutput, if responses are slow, fallback to noThumb before timing out page --->
+					<cfset puri='/images/noThumb.jpg'>
+				<cfelse>
+					<cfset puri=getMediaPreview(preview_uri,media_type)>
+				</cfif>
+				<span class="detailData">
+					<a href="/showTAG.cfm?media_id=#media_id#" target="_blank"><img src="#puri#" alt="#altText#"></a>
+				</span>
 			</cfloop>
 		</div>
 	</div>
 </cfif>
 <cfquery name="media" datasource="user_login" username="#session.dbuser#" password="#decrypt(session.epw,cfid)#">
-    select distinct
-        media.media_id,
-        media.media_uri,
-        media.mime_type,
-        media.media_type,
-        media.preview_uri,
-		media_relations.media_relationship
-     from
-         media,
-         media_relations,
-         media_labels
-     where
-         media.media_id=media_relations.media_id and
-         media.media_id=media_labels.media_id (+) and
-         media_relations.media_relationship like '%cataloged_item' and
-         media_relations.related_primary_key = <cfqueryparam value=#collection_object_id# CFSQLType="CF_SQL_DECIMAL" >
-         AND MCZBASE.is_media_encumbered(media.media_id) < 1
+	select distinct
+		media.media_id,
+		media.media_uri,
+		media.mime_type,
+		media.media_type,
+		media.preview_uri,
+		media_relations.media_relationship,
+		mczbase.get_media_descriptor(media.media_id) as media_descriptor
+	from
+		media,
+		media_relations,
+		media_labels
+	where
+		media.media_id=media_relations.media_id and
+		media.media_id=media_labels.media_id (+) and
+		media_relations.media_relationship like '%cataloged_item' and
+		media_relations.related_primary_key = <cfqueryparam value=#collection_object_id# CFSQLType="CF_SQL_DECIMAL" >
+		AND MCZBASE.is_media_encumbered(media.media_id) < 1
 	order by media.media_type
 </cfquery>
 <cfif media.recordcount gt 0>
-    <div class="detailCell">
+	<div class="detailCell">
 		<div class="detailLabel">Media
 		<cfquery name="wrlCount" dbtype="query">
 			select * from media where mime_type = 'model/vrml'
@@ -1575,23 +1752,23 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 				<!---div class="thumbs"--->
 					<div class="thumb_spcr">&nbsp;</div>
 					<cfloop query="media">
+						<cfset altText = media.media_descriptor>
 						<cfset puri=getMediaPreview(preview_uri,media_type)>
-		            	<cfquery name="labels"  datasource="user_login" username="#session.dbuser#" password="#decrypt(session.epw,cfid)#">
+		            <cfquery name="labels"  datasource="user_login" username="#session.dbuser#" password="#decrypt(session.epw,cfid)#">
 							select
 								media_label,
 								label_value
 							from
 								media_labels
 							where
-								media_id=#media_id#
-
+								media_id = <cfqueryparam cfsqltype="CF_SQL_DECIMAL" value="#media_id#">
 						</cfquery>
 						<cfquery name="desc" dbtype="query">
 							select label_value from labels where media_label='description'
 						</cfquery>
-						<cfset alt="Media Preview Image">
+						<cfset description="Media Preview Image">
 						<cfif desc.recordcount is 1>
-							<cfset alt=desc.label_value>
+							<cfset description=desc.label_value>
 						</cfif>
 						<cfif media_type eq "image" and media.media_relationship eq "shows cataloged_item" and mime_type NEQ "text/html">
                         	<cfset one_thumb = "<div class='one_thumb_box'>">
@@ -1603,11 +1780,31 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 						    <cfset aForDetHref = "/media/#media_id#">
 						</cfif>
 		              		#one_thumb#
-			               <a href="#aForImHref#" target="_blank"><img src="#getMediaPreview(preview_uri,media_type)#" alt="#alt#" class="theThumb"></a>
+			               <a href="#aForImHref#" target="_blank"><img src="#getMediaPreview(preview_uri,media_type)#" alt="#altText#" class="theThumb"></a>
 		                   	<p>
 								#media_type# (#mime_type#)
 			                   	<br><a href="#aForDetHref#" target="_blank">Media Details</a>
-								<br>#alt#
+								<br>#description#
+								<cfif #media_type# eq "audio">
+									<!--- check for a transcript, link if present --->
+									<cfquery name="checkForTranscript" datasource="user_login" username="#session.dbuser#" password="#decrypt(session.epw,cfid)#">
+										SELECT
+											transcript.media_uri as transcript_uri,
+											transcript.media_id as transcript_media_id
+										FROM
+											media_relations
+											left join media transcript on media_relations.media_id = transcript.media_id
+										WHERE
+											media_relations.related_primary_key = <cfqueryparam cfsqltype="CF_SQL_DECIMAL"value="#media_id#"> 
+											and media_relationship = 'transcript for audio media'
+											and MCZBASE.is_media_encumbered(transcript.media_id) < 1
+									</cfquery>
+									<cfif checkforTranscript.recordcount GT 0>
+										<cfloop query="checkForTranscript">
+											<br><span style='font-size:small'><a href="#transcript_uri#">View Transcript</a></span>
+										</cfloop>
+									</cfif>
+								</cfif>
 							</p>
 						</div>
 					</cfloop>
@@ -1651,5 +1848,23 @@ WHERE irel.related_coll_object_id=#collection_object_id#
 <cfif oneOfUs is 1>
 </form>
 </cfif>
+<cfif isdefined("session.roles") and listfindnocase(session.roles,"collops")>
+	<!---  For a small set of collections operations users, include the TDWG BDQ TG2 test integration --->
+	<script type='text/javascript' language="javascript" src='/dataquality/js/bdq_quality_control.js'></script>
+	<script>
+		function runTests() {
+			loadNameQC(#collection_object_id#, "", "NameDQDiv");
+			loadSpaceQC(#collection_object_id#, "", "SpatialDQDiv");
+			loadEventQC(#collection_object_id#, "", "EventDQDiv");
+		}
+	</script>
+	<input type="button" value="QC" class="savBtn" onClick=" runTests(); ">
+	<!---  Scientific Name tests --->
+	<div id="NameDQDiv"></div>
+	<!---  Spatial tests --->
+	<div id="SpatialDQDiv"></div>
+	<!---  Temporal tests --->
+	<div id="EventDQDiv"></div>
+</cfif>
 </cfoutput>
 <cf_customizeIFrame>
