<cfif (isdefined("session.roles") and
	session.roles contains "coldfusion_user") and
	(isdefined("session.force_password_change") and
	session.force_password_change is "yes" and
	cgi.script_name is not "/ChangePassword.cfm")>
	<cflocation url="/ChangePassword.cfm">
</cfif>
<cfset filePath = replace('#cgi.script_name#','//','/') >
<cfif fileexists(application.webDirectory & filePath)>
	<cfquery name="isValid" datasource="uam_god" cachedWithin="#CreateTimeSpan(0,1,0,0)#">
		select ROLE_NAME from cf_form_permissions
		where form_path = <cfqueryparam value="#filePath#" cfsqltype="CF_SQL_VARCHAR">
		union
		select ROLE_NAME from cf_form_permissions_r
		where form_path = <cfqueryparam value="#filePath#" cfsqltype="CF_SQL_VARCHAR">
	</cfquery>
	<cfif isValid.recordcount is 0>
		<cfset bad=true>
	<cfelseif valuelist(isValid.role_name) is not "public">
		<cfloop query="isValid">
			<cfif not listfindnocase(session.roles,role_name)>
				<cfset bad=true>
			</cfif>
		</cfloop>
	</cfif>
	<cfif isdefined("bad") and bad is true>
	    <cfoutput>
            <div class="basic_box">
                <cftry>
		    <cfmail subject="Access Violation" to="#Application.technicalEmail#" from="Security@#Application.fromEmail#" type="html">
				IP address (#cgi.HTTP_X_Forwarded_For# - #remote_host#) tried to access
				#cgi.script_name#


				<br>This message was generated by /CustomTags/rolecheck.cfm.
			</cfmail>
			<cfcatch></cfcatch>
			</cftry>
			<!--- make sure they're really logged out --->
			
			<div style="color:red;font-size:large;margin-left: 4em;">
				 <img src="/images/oops.gif" alt="[ unauthorized access ]" style="float:left; width: 50px;margin-right: 1em;"><p>You tried to visit a form for which you are not authorized, or your login has expired.
				<br>
				If this message is in error, please <a class="underline" href="/contact.cfm">contact us</a>.
                </p>
                
			</div>
               
			<cfheader statuscode="403" statustext="Forbidden">
			<cfabort>
                </div>
		</cfoutput>
	</cfif>
</cfif>
